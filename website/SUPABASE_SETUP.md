# Supabase Backend Setup for Focustime

This document outlines the steps needed to set up the Supabase backend for the Focustime contact form.

## 1. Create a Supabase Project

1. Go to [supabase.com](https://supabase.com/) and sign up/login
2. Create a new project
3. Choose a name for your project (e.g. "focustime")
4. Choose a strong database password
5. Choose a region close to your target audience (e.g. "West Europe")
6. Wait for your project to be set up

## 2. Set Up Database Table

Create a new table for storing contact form submissions:

```sql
CREATE TABLE contact_submissions (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  phone TEXT,
  partner_type TEXT NOT NULL,
  message TEXT NOT NULL,
  language TEXT NOT NULL,
  contacted BOOLEAN DEFAULT FALSE,
  notes TEXT
);

-- Add comment to the table
COMMENT ON TABLE contact_submissions IS 'Form submissions from potential partners';
```

## 3. Set Up Row Level Security Policies

1. Enable Row Level Security (RLS) on the `contact_submissions` table
2. Create policies to control access to the data:

```sql
-- Allow inserts from website visitors (anonymous)
CREATE POLICY "Allow anonymous inserts" ON contact_submissions
    FOR INSERT WITH CHECK (true);

-- Only authenticated users can view submissions
CREATE POLICY "Allow authenticated reads" ON contact_submissions
    FOR SELECT USING (auth.role() = 'authenticated');

-- Only authenticated users can update submissions
CREATE POLICY "Allow authenticated updates" ON contact_submissions
    FOR UPDATE USING (auth.role() = 'authenticated');
```

## 4. Configure Email Notifications with Resend

To send email notifications when a partner contact form is submitted:

1. Sign up for [Resend](https://resend.com) if you haven't already

2. Get your Resend API key from the dashboard

3. In your Supabase dashboard, go to:
   - Settings > API > Edge Functions
   - Add a new secret with the key `RESEND_API_KEY` and your API key as the value

4. Deploy the Edge Function:
   - Create a new folder in your project: `supabase/send-form-notification`
   - Add your Edge Function code in `index.ts`
   - Deploy the function with: `supabase functions deploy send-form-notification --project-ref YOUR_PROJECT_REF`

5. Set up a Database Webhook:
   - Go to Database → Webhooks in Supabase Dashboard
   - Create a new webhook
   - Set it to trigger on "INSERT" to the `contact_submissions` table
   - Point it to your Edge Function URL: `https://YOUR_PROJECT_REF.supabase.co/functions/v1/send-form-notification`

Your Edge Function will now send an email notification to `tjaco@focustime.io` whenever a new partner submission is received.

### Testing the Email Function

You can test the email function directly using cURL:

```bash
curl -X POST "https://YOUR_PROJECT_REF.supabase.co/functions/v1/send-form-notification" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test Partner",
    "email": "test@example.com",
    "phone": "+1234567890",
    "partner_type": "property",
    "message": "This is a test message",
    "language": "en"
  }'
```

## 5. Update Website with Supabase Configuration

In your `website/js/supabase.js` file, replace the placeholders with your actual Supabase URL and anon key:

```javascript
const SUPABASE_URL = 'https://your-project-id.supabase.co';
const SUPABASE_ANON_KEY = 'your-anon-key';
```

> ⚠️ **Security Note**: For production, consider using a server-side approach or environment variables to prevent exposing your Supabase anon key in client-side code.

## 6. Add Authentication (Optional)

If you want to access the submissions via your own admin interface:

1. Set up authentication in Supabase
2. Create a simple admin page that requires authentication
3. Display and manage submissions after successful login

## 7. Regular Backup

Set up regular backups of your Supabase database to ensure you don't lose any partner submissions.

## 8. Analytics Setup (Optional)

To track user engagement with your website, you can set up an analytics system using Supabase:

1. Create an analytics table in your Supabase database:

```sql
CREATE TABLE analytics_events (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  event_name TEXT NOT NULL,
  event_data JSONB NOT NULL
);

-- Add comment to the table
COMMENT ON TABLE analytics_events IS 'Website analytics events';

-- Create index for faster queries on event_name
CREATE INDEX idx_analytics_events_name ON analytics_events (event_name);
```

2. Set up Row Level Security for analytics data:

```sql
-- Enable RLS on the analytics_events table
ALTER TABLE analytics_events ENABLE ROW LEVEL SECURITY;

-- Allow inserts from website visitors (anonymous)
CREATE POLICY "Allow anonymous inserts" ON analytics_events
    FOR INSERT WITH CHECK (true);

-- Only authenticated users can view analytics data
CREATE POLICY "Allow authenticated reads" ON analytics_events
    FOR SELECT USING (auth.role() = 'authenticated');
```

3. Analytics events currently being tracked:
   - Page views
   - Language switches
   - Section visibility
   - Form interactions
   - Outbound link clicks

4. Create a dashboard (optional)
   - Use Supabase SQL editor to create queries for important metrics
   - Consider using a third-party visualization tool connected to your Supabase database

5. Privacy considerations
   - Ensure your privacy policy discloses data collection
   - Respect "Do Not Track" browser settings (already implemented in the code)
   - Consider implementing a cookie consent banner for GDPR compliance
